<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理与积分系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        neutral: '#F5F5F5',
                        'neutral-dark': '#262626'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-lift:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 30px rgba(22, 93, 255, 0.15);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .slide-in {
                animation: slideIn 0.5s ease forwards;
            }
            @keyframes slideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .modal-backdrop {
                backdrop-filter: blur(3px);
            }
            .chart-container {
                position: relative;
                height: 300px;
                width: 100%;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-neutral-dark min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-tasks text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">任务积分系统</h1>
            </div>
            
            <div id="userInfo" class="flex items-center space-x-4">
                <div id="scoreDisplay" class="hidden items-center bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fa fa-star mr-1"></i>
                    <span id="currentScore">0</span>分
                </div>
                <button id="logoutBtn" class="hidden text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-sign-out mr-1"></i>退出
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-24 pb-16">
        <!-- 登录/角色选择界面 -->
        <section id="loginSection" class="max-w-md mx-auto fade-in">
            <div class="bg-white rounded-xl p-8 card-shadow">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">请选择用户类型</h2>
                
                <div class="space-y-4">
                    <button id="adminLogin" class="w-full py-3 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium transition-all flex items-center justify-center hover-lift">
                        <i class="fa fa-user-circle mr-2"></i>管理员登录
                    </button>
                    
                    <button id="visitorLogin" class="w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-all flex items-center justify-center hover-lift">
                        <i class="fa fa-user mr-2"></i>访客登录
                    </button>
                </div>
                
                <div class="mt-6 text-center text-gray-500 text-sm">
                    <p>登录后即可使用系统功能</p>
                </div>
            </div>
        </section>

        <!-- 管理员界面 -->
        <section id="adminSection" class="hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">管理员面板</h2>
                <div class="bg-primary/10 text-primary px-4 py-2 rounded-lg font-medium">
                    <i class="fa fa-calendar mr-1"></i>
                    <span id="currentDate"></span>
                </div>
            </div>
            
            <!-- 积分信息卡片 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">当前积分状态</h3>
                    <div class="flex space-x-2 mt-2 md:mt-0">
                        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                            <button id="decreaseScoreBtn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">
                                <i class="fa fa-minus"></i>
                            </button>
                            <input type="number" id="scoreAdjustAmount" min="1" value="1" 
                                class="w-16 text-center border-x border-gray-300 py-1.5 focus:outline-none">
                            <button id="increaseScoreBtn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                        <button id="resetScoreBtn" class="px-4 py-1.5 bg-danger hover:bg-danger/90 text-white rounded-lg text-sm font-medium transition-all flex items-center justify-center">
                            <i class="fa fa-trash mr-1.5"></i>清零积分
                        </button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center md:items-start justify-between">
                    <div class="text-center md:text-left mb-4 md:mb-0">
                        <p class="text-gray-500 mb-1">当前积分</p>
                        <p id="adminCurrentScore" class="text-4xl font-bold text-primary">0</p>
                    </div>
                    
                    <div class="text-center mb-4 md:mb-0">
                        <p class="text-gray-500 mb-1">上周差距</p>
                        <p id="lastWeekGap" class="text-2xl font-bold">--</p>
                    </div>
                    
                    <div class="text-center md:text-right">
                        <p class="text-gray-500 mb-1">本周剩余天数</p>
                        <p id="daysRemaining" class="text-2xl font-bold text-secondary">0</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-1 text-primary"></i>
                    <span>系统每天凌晨5点自动结算前一天未完成的任务，并将其转为今日任务。分数可负，每周结算时统一处理。</span>
                </div>
            </div>
            
            <!-- 待审核任务区域 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in" style="animation-delay: 0.05s">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-700">待审核任务</h3>
                    <span id="pendingReviewCount" class="bg-warning/10 text-warning px-2 py-1 rounded-full text-sm">
                        待审核 <span id="reviewCount">0</span> 个任务
                    </span>
                </div>
                
                <div id="pendingReviewList" class="space-y-3">
                    <!-- 待审核任务将通过JS动态添加 -->
                    <div class="text-center text-gray-500 py-6" id="noPendingReviewMessage">
                        暂无待审核任务
                    </div>
                </div>
            </div>
            
            <!-- 任务管理区域 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in" style="animation-delay: 0.1s">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-700">今日任务管理</h3>
                    <span id="taskCountIndicator" class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-sm">
                        已添加 <span id="taskCount">0</span>/3 个任务
                    </span>
                </div>
                
                <div id="addTaskContainer" class="mb-6">
                    <input type="text" id="newTaskInput" placeholder="输入新任务..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                    <button id="addTaskBtn" class="mt-3 w-full py-2 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium transition-all flex items-center justify-center">
                        <i class="fa fa-plus mr-2"></i>添加任务
                    </button>
                </div>
                
                <div id="adminTasksList" class="space-y-3">
                    <!-- 任务项将通过JS动态添加 -->
                    <div class="text-center text-gray-500 py-6" id="noTasksMessage">
                        尚未添加任务，点击上方按钮添加
                    </div>
                </div>
            </div>
            
            <!-- 30天分数统计 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in" style="animation-delay: 0.15s">
                <h3 class="text-lg font-semibold mb-6 text-gray-700">近30天分数统计</h3>
                <div class="chart-container">
                    <canvas id="adminScoreChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-500 text-center" id="noScoreStatsMessage">
                    暂无足够数据生成图表
                </div>
            </div>
            
            <!-- 任务历史记录 -->
            <div class="bg-white rounded-xl p-6 card-shadow slide-in" style="animation-delay: 0.2s">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">任务历史记录</h3>
                <div id="taskHistory" class="max-h-60 overflow-y-auto space-y-2">
                    <!-- 历史记录将通过JS动态添加 -->
                    <div class="text-center text-gray-500 py-6">
                        暂无历史记录
                    </div>
                </div>
            </div>
        </section>

        <!-- 访客界面 -->
        <section id="visitorSection" class="hidden fade-in">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">访客面板</h2>
                <div class="bg-primary/10 text-primary px-4 py-2 rounded-lg font-medium">
                    <i class="fa fa-calendar mr-1"></i>
                    <span id="visitorCurrentDate"></span>
                </div>
            </div>
            
            <!-- 积分信息卡片 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">我的积分</h3>
                <div class="flex flex-col md:flex-row items-center md:items-start justify-between">
                    <div class="text-center md:text-left mb-4 md:mb-0">
                        <p class="text-gray-500 mb-1">当前积分</p>
                        <p id="visitorCurrentScore" class="text-4xl font-bold text-primary">0</p>
                    </div>
                    
                    <div class="text-center mb-4 md:mb-0">
                        <p class="text-gray-500 mb-1">上周差距</p>
                        <p id="visitorLastWeekGap" class="text-2xl font-bold">--</p>
                    </div>
                    
                    <div class="text-center md:text-right">
                        <p class="text-gray-500 mb-1">今日任务状态</p>
                        <p id="todayTaskStatus" class="text-2xl font-bold text-secondary">0/3</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-1 text-primary"></i>
                    <span>系统每天凌晨5点自动结算前一天未完成的任务，并将其转为今日任务。分数可负，每周结算时统一处理。</span>
                </div>
            </div>
            
            <!-- 30天分数统计 -->
            <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in" style="animation-delay: 0.05s">
                <h3 class="text-lg font-semibold mb-6 text-gray-700">近30天分数统计</h3>
                <div class="chart-container">
                    <canvas id="visitorScoreChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-500 text-center" id="noVisitorScoreStatsMessage">
                    暂无足够数据生成图表
                </div>
            </div>
            
            <!-- 今日任务列表 -->
            <div class="bg-white rounded-xl p-6 card-shadow slide-in" style="animation-delay: 0.1s">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">今日任务</h3>
                
                <div id="visitorTasksList" class="space-y-3">
                    <!-- 任务项将通过JS动态添加 -->
                    <div class="text-center text-gray-500 py-6" id="noVisitorTasksMessage">
                        管理员尚未布置今日任务
                    </div>
                </div>
            </div>
            
            <!-- 任务历史记录 -->
            <div class="bg-white rounded-xl p-6 mt-8 card-shadow slide-in" style="animation-delay: 0.2s">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">近期任务记录</h3>
                <div id="visitorTaskHistory" class="max-h-60 overflow-y-auto space-y-2">
                    <!-- 历史记录将通过JS动态添加 -->
                    <div class="text-center text-gray-500 py-6">
                        暂无任务记录
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>任务积分管理系统 &copy; <span id="currentYear"></span></p>
        </div>
    </footer>

    <!-- 通知提示组件 -->
    <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationText"></span>
    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-800 mb-3">确认操作</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6">确认要执行此操作吗？</p>
            <div class="flex space-x-3">
                <button id="cancelBtn" class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button id="confirmBtn" class="flex-1 py-2 bg-danger text-white rounded-lg font-medium hover:bg-danger/90 transition-colors">
                    确认
                </button>
            </div>
        </div>
    </div>

    <!-- 管理员密码登录框 -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-800 mb-3">管理员登录</h3>
            <p class="text-gray-600 mb-4">请输入管理员密码</p>
            <div class="mb-4">
                <input type="password" id="adminPassword" placeholder="输入密码..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
            </div>
            <div class="flex space-x-3">
                <button id="cancelAdminLoginBtn" class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button id="confirmAdminLoginBtn" class="flex-1 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                    登录
                </button>
            </div>
        </div>
    </div>

    <!-- 访客密码登录框 -->
    <div id="visitorLoginModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-800 mb-3">访客登录</h3>
            <p class="text-gray-600 mb-4">请输入访客密码</p>
            <div class="mb-4">
                <input type="password" id="visitorPassword" placeholder="输入密码..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
            </div>
            <div class="flex space-x-3">
                <button id="cancelVisitorLoginBtn" class="flex-1 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                    取消
                </button>
                <button id="confirmVisitorLoginBtn" class="flex-1 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                    登录
                </button>
            </div>
        </div>
    </div>

    <script>
        // 数据模型
        const appData = {
            currentUser: null, // 'admin' 或 'visitor'
            score: 0,
            lastWeekGap: 0,
            tasks: [], // 今日任务
            pendingTasksFromPreviousDay: [], // 前一天未完成的任务
            taskHistory: [], // 任务历史记录
            scoreHistory: [], // 分数历史记录，用于统计
            lastResetDate: null, // 上次周结算日期
            lastDailySettlementDate: null, // 上次每日结算日期
            lastScoreRecordDate: null, // 上次记录分数的日期
            
            // 初始化数据
            init() {
                const savedData = localStorage.getItem('taskSystemData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    this.score = parsed.score || 0;
                    this.lastWeekGap = parsed.lastWeekGap || 0;
                    this.tasks = parsed.tasks || [];
                    this.pendingTasksFromPreviousDay = parsed.pendingTasksFromPreviousDay || [];
                    this.taskHistory = parsed.taskHistory || [];
                    this.scoreHistory = parsed.scoreHistory || [];
                    this.lastResetDate = parsed.lastResetDate;
                    this.lastDailySettlementDate = parsed.lastDailySettlementDate;
                    this.lastScoreRecordDate = parsed.lastScoreRecordDate;
                }
                
                // 优化内存，只保留最近的任务历史
                this.optimizeMemory();
                
                // 记录今日初始分数（如果还没有记录）
                this.recordDailyScoreIfNeeded();
                
                // 检查是否需要每日结算（凌晨5点）
                this.checkDailySettlement();
                
                // 检查是否需要周结算
                this.checkWeeklyReset();
                
                // 检查是否需要清空当天任务（新的一天）并添加前一天未完成的任务
                this.checkDailyReset();
                
                this.save();
            },
            
            // 保存数据到本地存储
            save() {
                const dataToSave = {
                    score: this.score,
                    lastWeekGap: this.lastWeekGap,
                    tasks: this.tasks,
                    pendingTasksFromPreviousDay: this.pendingTasksFromPreviousDay,
                    taskHistory: this.taskHistory,
                    scoreHistory: this.scoreHistory,
                    lastResetDate: this.lastResetDate,
                    lastDailySettlementDate: this.lastDailySettlementDate,
                    lastScoreRecordDate: this.lastScoreRecordDate
                };
                localStorage.setItem('taskSystemData', JSON.stringify(dataToSave));
            },
            
            // 优化内存，删除无用信息
            optimizeMemory() {
                // 只保留最近30天的分数历史
                if (this.scoreHistory.length > 30) {
                    this.scoreHistory = this.scoreHistory.slice(-30);
                }
                
                // 只保留最近100条任务历史
                if (this.taskHistory.length > 100) {
                    this.taskHistory = this.taskHistory.slice(-100);
                }
            },
            
            // 记录每日分数（如果当天还没有记录）
            recordDailyScoreIfNeeded() {
                const todayStr = new Date().toISOString().split('T')[0];
                
                // 如果今天已经记录过分数，不再重复记录
                if (this.lastScoreRecordDate === todayStr) {
                    return;
                }
                
                // 如果有历史记录，计算与前一天的差异
                let scoreDiff = 0;
                if (this.scoreHistory.length > 0) {
                    const lastRecord = this.scoreHistory[this.scoreHistory.length - 1];
                    scoreDiff = this.score - lastRecord.endScore;
                }
                
                // 添加今天的分数记录
                this.scoreHistory.push({
                    date: todayStr,
                    scoreDiff: scoreDiff,
                    endScore: this.score
                });
                
                // 更新最后记录日期
                this.lastScoreRecordDate = todayStr;
                
                // 优化内存
                this.optimizeMemory();
                
                this.save();
            },
            
            // 添加新任务
            addTask(taskText) {
                if (this.tasks.length >= 3) return false;
                
                const task = {
                    id: Date.now().toString(),
                    text: taskText,
                    status: 'pending', // pending, submitted, approved, rejected
                    createdAt: new Date().toISOString(),
                    isCarriedOver: false // 是否是从昨天延续过来的任务
                };
                
                this.tasks.push(task);
                this.save();
                return true;
            },
            
            // 删除任务
            deleteTask(taskId) {
                const initialLength = this.tasks.length;
                this.tasks = this.tasks.filter(t => t.id !== taskId);
                
                if (this.tasks.length !== initialLength) {
                    this.save();
                    return true;
                }
                return false;
            },
            
            // 调整积分
            adjustScore(amount) {
                this.score += amount;
                this.save();
                
                // 记录分数变化
                this.recordDailyScoreIfNeeded();
                
                if (amount > 0) {
                    this.showNotification(`积分增加 ${amount} 分`, 'success');
                } else if (amount < 0) {
                    this.showNotification(`积分减少 ${-amount} 分`, 'warning');
                }
            },
            
            // 清零积分
            resetScore() {
                this.score = 0;
                this.save();
                
                // 记录分数变化
                this.recordDailyScoreIfNeeded();
                
                this.showNotification('积分已成功清零', 'info');
            },
            
            // 用户提交任务（等待审核）
            submitTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task || task.status !== 'pending') return false;
                
                task.status = 'submitted';
                task.submittedAt = new Date().toISOString();
                
                this.save();
                return true;
            },
            
            // 管理员审核任务
            reviewTask(taskId, approved) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task || task.status !== 'submitted') return false;
                
                if (approved) {
                    task.status = 'approved';
                    task.approvedAt = new Date().toISOString();
                    
                    // 计算积分
                    this.calculatePoints(task, 'completed');
                } else {
                    task.status = 'rejected';
                    task.rejectedAt = new Date().toISOString();
                }
                
                // 添加到历史记录
                if (approved) {
                    this.taskHistory.unshift({
                        ...task,
                        date: new Date().toISOString().split('T')[0],
                        status: 'completed'
                    });
                }
                
                this.save();
                return true;
            },
            
            // 计算积分
            calculatePoints(task, status) {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0是周日，6是周六
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                if (status === 'completed') {
                    this.score += 1;
                    this.showNotification('任务完成，+1分！', 'success');
                } else if (status === 'abandoned' && !isWeekend) {
                    this.score -= 1;
                    this.showNotification('任务放弃，-1分！', 'warning');
                }
                
                // 记录分数变化
                this.recordDailyScoreIfNeeded();
            },
            
            // 每日结算（处理未完成的任务）
            dailySettlement() {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                // 获取所有未完成的任务
                const pendingTasks = this.tasks.filter(t => 
                    t.status === 'pending' || 
                    t.status === 'submitted' || 
                    t.status === 'rejected'
                );
                
                if (pendingTasks.length > 0) {
                    const dayOfWeek = yesterday.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    // 保存未完成的任务，用于明天自动添加
                    this.pendingTasksFromPreviousDay = pendingTasks.map(task => {
                        // 对于被拒绝的任务，重置为待完成状态
                        if (task.status === 'rejected') {
                            return {
                                ...task,
                                status: 'pending',
                                isCarriedOver: true
                            };
                        }
                        // 对于提交待审核的任务，自动通过
                        if (task.status === 'submitted') {
                            return {
                                ...task,
                                status: 'approved',
                                isAutoApproved: true,
                                isCarriedOver: false
                            };
                        }
                        return {
                            ...task,
                            isCarriedOver: true
                        };
                    });
                    
                    pendingTasks.forEach(task => {
                        // 处理待审核任务 - 自动通过
                        if (task.status === 'submitted') {
                            task.status = 'approved';
                            task.approvedAt = new Date(yesterdayStr + 'T05:00:00.000Z').toISOString();
                            task.isAutoApproved = true;
                            
                            // 计算积分
                            this.calculatePoints(task, 'completed');
                            
                            // 添加到历史记录
                            this.taskHistory.unshift({
                                ...task,
                                date: yesterdayStr,
                                status: 'completed',
                                isAutoApproved: true
                            });
                        } 
                        // 处理被拒绝的任务 - 转为待完成并延续到明天
                        else if (task.status === 'rejected') {
                            // 不扣分，只是延续任务
                            task.status = 'pending';
                        }
                        // 处理未提交的任务 - 标记为放弃
                        else if (task.status === 'pending') {
                            task.status = 'abandoned';
                            task.completedAt = new Date(yesterdayStr + 'T05:00:00.000Z').toISOString();
                            task.isAutoSettled = true;
                            
                            // 计算积分（仅工作日扣分）
                            if (!isWeekend) {
                                this.score -= 1;
                            }
                            
                            // 添加到历史记录
                            this.taskHistory.unshift({
                                ...task,
                                date: yesterdayStr,
                                status: 'abandoned',
                                isAutoSettled: true
                            });
                        }
                    });
                    
                    this.showNotification(`已自动结算 ${pendingTasks.length} 个未完成任务，待审核任务已自动通过`, 'info');
                } else {
                    this.pendingTasksFromPreviousDay = [];
                }
                
                // 记录当天的最终分数
                this.recordDailyScoreIfNeeded();
                
                // 记录结算日期
                this.lastDailySettlementDate = yesterdayStr;
                this.save();
            },
            
            // 检查是否需要每日结算（凌晨5点）
            checkDailySettlement() {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                
                // 如果从未结算过，初始化
                if (!this.lastDailySettlementDate) {
                    // 如果当前时间已过凌晨5点，设置为昨天
                    if (currentHour >= 5) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        this.lastDailySettlementDate = yesterday.toISOString().split('T')[0];
                        this.dailySettlement(); // 执行一次结算
                    } else {
                        // 否则设置为前天
                        const dayBeforeYesterday = new Date();
                        dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
                        this.lastDailySettlementDate = dayBeforeYesterday.toISOString().split('T')[0];
                    }
                    this.save();
                    return;
                }
                
                // 判断是否需要结算（当前时间已过凌晨5点，且上次结算不是昨天）
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (currentHour >= 5 && this.lastDailySettlementDate !== yesterdayStr) {
                    this.dailySettlement();
                }
            },
            
            // 检查是否需要周结算
            checkWeeklyReset() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // 如果从未重置过，设置为今天
                if (!this.lastResetDate) {
                    this.lastResetDate = todayStr;
                    return;
                }
                
                const lastReset = new Date(this.lastResetDate);
                const daysSinceReset = Math.floor((today - lastReset) / (1000 * 60 * 60 * 24));
                
                // 如果超过7天，执行周结算
                if (daysSinceReset >= 7) {
                    // 计算上周差距
                    this.lastWeekGap = 10 - this.score;
                    
                    // 每周结算时清零分数
                    this.score = 0;
                    
                    // 记录分数变化
                    this.recordDailyScoreIfNeeded();
                    
                    this.lastResetDate = todayStr;
                    this.save();
                    this.showNotification('每周结算已完成，积分已清零', 'info');
                }
            },
            
            // 检查是否需要清空当天任务并添加前一天未完成的任务
            checkDailyReset() {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // 检查是否有任务不是今天创建的
                if (this.tasks.length > 0) {
                    const firstTaskDate = new Date(this.tasks[0].createdAt).toISOString().split('T')[0];
                    if (firstTaskDate !== todayStr) {
                        // 清空当天任务，添加前一天未完成的任务
                        this.tasks = this.pendingTasksFromPreviousDay.map(task => ({
                            ...task,
                            id: Date.now().toString() + '-' + task.id, // 生成新ID
                            createdAt: new Date().toISOString() // 更新创建时间为今天
                        }));
                        this.save();
                    }
                } else if (this.pendingTasksFromPreviousDay.length > 0) {
                    // 如果今天没有任务但有前一天未完成的任务，添加它们
                    this.tasks = this.pendingTasksFromPreviousDay.map(task => ({
                        ...task,
                        id: Date.now().toString() + '-' + task.id,
                        createdAt: new Date().toISOString()
                    }));
                    this.save();
                }
            },
            
            // 显示通知
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const icon = document.getElementById('notificationIcon');
                const text = document.getElementById('notificationText');
                
                // 设置通知类型样式
                notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center';
                
                if (type === 'success') {
                    notification.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
                    icon.className = 'fa fa-check-circle mr-2';
                } else if (type === 'warning') {
                    notification.classList.add('bg-warning/10', 'text-warning', 'border', 'border-warning/30');
                    icon.className = 'fa fa-exclamation-circle mr-2';
                } else if (type === 'error') {
                    notification.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
                    icon.className = 'fa fa-times-circle mr-2';
                } else {
                    notification.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
                    icon.className = 'fa fa-info-circle mr-2';
                }
                
                // 负分时显示为红色
                if (message.includes('积分减少') && this.score < 0) {
                    notification.classList.remove('bg-warning/10', 'text-warning', 'border', 'border-warning/30');
                    notification.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
                    icon.className = 'fa fa-exclamation-triangle mr-2';
                }
                
                text.textContent = message;
                
                // 3秒后隐藏通知
                setTimeout(() => {
                    notification.classList.remove('translate-y-0', 'opacity-100');
                    notification.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }
        };

        // 视图控制器
        const viewController = {
            confirmCallback: null,
            scoreAdjustmentAmount: 1,
            adminScoreChart: null,
            visitorScoreChart: null,
            
            // 初始化页面
            init() {
                // 确保DOM完全加载后再执行初始化
                document.addEventListener('DOMContentLoaded', () => {
                    // 设置当前年份
                    document.getElementById('currentYear').textContent = new Date().getFullYear();
                    
                    // 设置当前日期
                    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                    const currentDate = new Date().toLocaleDateString('zh-CN', dateOptions);
                    document.getElementById('currentDate').textContent = currentDate;
                    document.getElementById('visitorCurrentDate').textContent = currentDate;
                    
                    // 计算本周剩余天数
                    const dayOfWeek = new Date().getDay(); // 0是周日，6是周六
                    const daysToSunday = dayOfWeek === 0 ? 7 : 7 - dayOfWeek;
                    document.getElementById('daysRemaining').textContent = daysToSunday;
                    
                    // 绑定事件监听
                    this.bindEvents();
                    
                    // 初始化图表
                    this.initCharts();
                    
                    // 初始渲染
                    this.render();
                });
            },
            
            // 初始化图表
            initCharts() {
                // 管理员图表
                const adminCtx = document.getElementById('adminScoreChart').getContext('2d');
                this.adminScoreChart = new Chart(adminCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '每日积分',
                            data: [],
                            borderColor: '#165DFF',
                            backgroundColor: 'rgba(22, 93, 255, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#165DFF',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#333',
                                bodyColor: '#666',
                                borderColor: '#ddd',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `积分: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 访客图表
                const visitorCtx = document.getElementById('visitorScoreChart').getContext('2d');
                this.visitorScoreChart = new Chart(visitorCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '每日积分',
                            data: [],
                            borderColor: '#165DFF',
                            backgroundColor: 'rgba(22, 93, 255, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#165DFF',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#333',
                                bodyColor: '#666',
                                borderColor: '#ddd',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `积分: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            // 更新图表数据
            updateChartData(chart, historyData) {
                if (!chart) return;
                
                // 准备图表数据
                const labels = [];
                const data = [];
                
                // 只使用有数据的记录
                historyData.forEach(record => {
                    // 格式化日期显示
                    const date = new Date(record.date);
                    const formattedDate = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                    
                    labels.push(formattedDate);
                    data.push(record.endScore);
                });
                
                // 更新图表数据
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
                
                // 根据是否有数据显示/隐藏提示信息
                if (historyData.length > 0) {
                    if (appData.currentUser === 'admin') {
                        document.getElementById('noScoreStatsMessage').classList.add('hidden');
                    } else {
                        document.getElementById('noVisitorScoreStatsMessage').classList.add('hidden');
                    }
                } else {
                    if (appData.currentUser === 'admin') {
                        document.getElementById('noScoreStatsMessage').classList.remove('hidden');
                    } else {
                        document.getElementById('noVisitorScoreStatsMessage').classList.remove('hidden');
                    }
                }
            },
            
            // 绑定事件监听
            bindEvents() {
                // 确保DOM元素存在后再绑定事件
                if (document.getElementById('adminLogin')) {
                    document.getElementById('adminLogin').addEventListener('click', () => {
                        console.log('管理员登录按钮被点击');
                        this.showAdminLoginModal();
                    });
                }
                
                if (document.getElementById('visitorLogin')) {
                    document.getElementById('visitorLogin').addEventListener('click', () => {
                        console.log('访客登录按钮被点击');
                        this.showVisitorLoginModal();
                    });
                }
                
                // 管理员登录模态框按钮
                if (document.getElementById('cancelAdminLoginBtn')) {
                    document.getElementById('cancelAdminLoginBtn').addEventListener('click', () => {
                        this.hideAdminLoginModal();
                    });
                }
                
                if (document.getElementById('confirmAdminLoginBtn')) {
                    document.getElementById('confirmAdminLoginBtn').addEventListener('click', () => {
                        this.handleAdminLogin();
                    });
                }
                
                // 管理员密码框回车登录
                if (document.getElementById('adminPassword')) {
                    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleAdminLogin();
                        }
                    });
                }
                
                // 访客登录模态框按钮
                if (document.getElementById('cancelVisitorLoginBtn')) {
                    document.getElementById('cancelVisitorLoginBtn').addEventListener('click', () => {
                        this.hideVisitorLoginModal();
                    });
                }
                
                if (document.getElementById('confirmVisitorLoginBtn')) {
                    document.getElementById('confirmVisitorLoginBtn').addEventListener('click', () => {
                        this.handleVisitorLogin();
                    });
                }
                
                // 访客密码框回车登录
                if (document.getElementById('visitorPassword')) {
                    document.getElementById('visitorPassword').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleVisitorLogin();
                        }
                    });
                }
                
                // 退出按钮
                if (document.getElementById('logoutBtn')) {
                    document.getElementById('logoutBtn').addEventListener('click', () => {
                        appData.currentUser = null;
                        this.render();
                    });
                }
                
                // 添加任务按钮
                if (document.getElementById('addTaskBtn')) {
                    document.getElementById('addTaskBtn').addEventListener('click', () => {
                        const input = document.getElementById('newTaskInput');
                        const taskText = input.value.trim();
                        
                        if (taskText) {
                            const success = appData.addTask(taskText);
                            if (success) {
                                input.value = '';
                                this.renderTasks();
                                appData.showNotification('任务添加成功');
                            } else {
                                appData.showNotification('每天最多只能添加3个任务', 'warning');
                            }
                        } else {
                            appData.showNotification('请输入任务内容', 'warning');
                        }
                    });
                }
                
                // 输入框回车添加任务
                if (document.getElementById('newTaskInput')) {
                    document.getElementById('newTaskInput').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('addTaskBtn').click();
                        }
                    });
                }
                
                // 积分调整按钮
                if (document.getElementById('decreaseScoreBtn')) {
                    document.getElementById('decreaseScoreBtn').addEventListener('click', () => {
                        const amountInput = document.getElementById('scoreAdjustAmount');
                        const amount = parseInt(amountInput.value) || 1;
                        this.showConfirmModal(
                            `确认要减少 ${amount} 分吗？`,
                            () => {
                                appData.adjustScore(-amount);
                                this.updateScoreDisplays();
                                this.renderScoreCharts();
                            }
                        );
                    });
                }
                
                if (document.getElementById('increaseScoreBtn')) {
                    document.getElementById('increaseScoreBtn').addEventListener('click', () => {
                        const amountInput = document.getElementById('scoreAdjustAmount');
                        const amount = parseInt(amountInput.value) || 1;
                        this.showConfirmModal(
                            `确认要增加 ${amount} 分吗？`,
                            () => {
                                appData.adjustScore(amount);
                                this.updateScoreDisplays();
                                this.renderScoreCharts();
                            }
                        );
                    });
                }
                
                // 积分调整输入框
                if (document.getElementById('scoreAdjustAmount')) {
                    document.getElementById('scoreAdjustAmount').addEventListener('change', (e) => {
                        let value = parseInt(e.target.value) || 1;
                        if (value < 1) value = 1;
                        e.target.value = value;
                    });
                }
                
                // 清零积分按钮
                if (document.getElementById('resetScoreBtn')) {
                    document.getElementById('resetScoreBtn').addEventListener('click', () => {
                        this.showConfirmModal(
                            '确认要清零所有积分吗？此操作不可恢复。',
                            () => {
                                appData.resetScore();
                                this.updateScoreDisplays();
                                this.renderScoreCharts();
                            }
                        );
                    });
                }
                
                // 确认对话框按钮
                if (document.getElementById('cancelBtn')) {
                    document.getElementById('cancelBtn').addEventListener('click', () => {
                        this.hideConfirmModal();
                    });
                }
                
                if (document.getElementById('confirmBtn')) {
                    document.getElementById('confirmBtn').addEventListener('click', () => {
                        if (this.confirmCallback) {
                            this.confirmCallback();
                        }
                        this.hideConfirmModal();
                    });
                }
            },
            
            // 显示管理员登录模态框
            showAdminLoginModal() {
                const modal = document.getElementById('adminLoginModal');
                if (!modal) {
                    console.error('未找到管理员登录模态框元素');
                    return;
                }
                
                const passwordInput = document.getElementById('adminPassword');
                if (passwordInput) {
                    passwordInput.value = '';
                }
                
                // 移除隐藏类
                modal.classList.remove('opacity-0', 'pointer-events-none');
                
                // 找到模态框内容并添加动画
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
                
                // 聚焦密码框
                if (passwordInput) {
                    setTimeout(() => {
                        passwordInput.focus();
                    }, 300);
                }
            },
            
            // 隐藏管理员登录模态框
            hideAdminLoginModal() {
                const modal = document.getElementById('adminLoginModal');
                if (!modal) return;
                
                modal.classList.add('opacity-0', 'pointer-events-none');
                
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-100');
                    modalContent.classList.add('scale-95');
                }
            },
            
            // 处理管理员登录
            handleAdminLogin() {
                const passwordInput = document.getElementById('adminPassword');
                if (!passwordInput) return;
                
                const password = passwordInput.value;
                
                if (password === 'passwd') {
                    appData.currentUser = 'admin';
                    this.hideAdminLoginModal();
                    this.render();
                } else {
                    // 密码错误动画
                    passwordInput.classList.add('border-danger');
                    
                    setTimeout(() => {
                        passwordInput.classList.remove('border-danger');
                    }, 1000);
                    
                    appData.showNotification('密码错误，请重新输入', 'error');
                }
            },
            
            // 显示访客登录模态框
            showVisitorLoginModal() {
                const modal = document.getElementById('visitorLoginModal');
                if (!modal) {
                    console.error('未找到访客登录模态框元素');
                    return;
                }
                
                const passwordInput = document.getElementById('visitorPassword');
                if (passwordInput) {
                    passwordInput.value = '';
                }
                
                modal.classList.remove('opacity-0', 'pointer-events-none');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
                
                // 聚焦密码框
                if (passwordInput) {
                    setTimeout(() => {
                        passwordInput.focus();
                    }, 300);
                }
            },
            
            // 隐藏访客登录模态框
            hideVisitorLoginModal() {
                const modal = document.getElementById('visitorLoginModal');
                if (!modal) return;
                
                modal.classList.add('opacity-0', 'pointer-events-none');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-100');
                    modalContent.classList.add('scale-95');
                }
            },
            
            // 处理访客登录
            handleVisitorLogin() {
                const passwordInput = document.getElementById('visitorPassword');
                if (!passwordInput) return;
                
                const password = passwordInput.value;
                
                if (password === 'tomato') {
                    appData.currentUser = 'visitor';
                    this.hideVisitorLoginModal();
                    this.render();
                } else {
                    // 密码错误动画
                    passwordInput.classList.add('border-danger');
                    
                    setTimeout(() => {
                        passwordInput.classList.remove('border-danger');
                    }, 1000);
                    
                    appData.showNotification('密码错误，请重新输入', 'error');
                }
            },
            
            // 显示确认对话框
            showConfirmModal(message, callback) {
                const modal = document.getElementById('confirmModal');
                if (!modal) return;
                
                const messageElement = document.getElementById('confirmMessage');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                
                this.confirmCallback = callback;
                
                modal.classList.remove('opacity-0', 'pointer-events-none');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
            },
            
            // 隐藏确认对话框
            hideConfirmModal() {
                const modal = document.getElementById('confirmModal');
                if (!modal) return;
                
                modal.classList.add('opacity-0', 'pointer-events-none');
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.remove('scale-100');
                    modalContent.classList.add('scale-95');
                }
                this.confirmCallback = null;
            },
            
            // 渲染整个页面
            render() {
                // 显示正确的界面
                if (appData.currentUser === 'admin') {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('adminSection').classList.remove('hidden');
                    document.getElementById('visitorSection').classList.add('hidden');
                    this.renderAdminInterface();
                } else if (appData.currentUser === 'visitor') {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('adminSection').classList.add('hidden');
                    document.getElementById('visitorSection').classList.remove('hidden');
                    this.renderVisitorInterface();
                } else {
                    document.getElementById('loginSection').classList.remove('hidden');
                    document.getElementById('adminSection').classList.add('hidden');
                    document.getElementById('visitorSection').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.add('hidden');
                    document.getElementById('scoreDisplay').classList.add('hidden');
                }
            },
            
            // 渲染管理员界面
            renderAdminInterface() {
                // 显示用户信息和退出按钮
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('scoreDisplay').classList.remove('hidden');
                document.getElementById('currentScore').textContent = appData.score;
                
                // 负分时显示为红色
                if (appData.score < 0) {
                    document.getElementById('currentScore').classList.add('text-danger');
                    document.getElementById('adminCurrentScore').classList.add('text-danger');
                } else {
                    document.getElementById('currentScore').classList.remove('text-danger');
                    document.getElementById('adminCurrentScore').classList.remove('text-danger');
                }
                
                // 更新积分显示
                document.getElementById('adminCurrentScore').textContent = appData.score;
                
                // 更新上周差距显示
                document.getElementById('lastWeekGap').textContent = appData.lastWeekGap >= 0 
                    ? `差 ${appData.lastWeekGap} 分` 
                    : `超额 ${-appData.lastWeekGap} 分`;
                
                // 渲染待审核任务
                this.renderPendingReviews();
                
                // 渲染任务列表
                this.renderTasks();
                
                // 渲染分数统计图表
                this.renderScoreCharts();
                
                // 渲染任务历史
                this.renderTaskHistory();
            },
            
            // 渲染访客界面
            renderVisitorInterface() {
                // 显示用户信息和退出按钮
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('scoreDisplay').classList.remove('hidden');
                document.getElementById('currentScore').textContent = appData.score;
                
                // 负分时显示为红色
                if (appData.score < 0) {
                    document.getElementById('currentScore').classList.add('text-danger');
                    document.getElementById('visitorCurrentScore').classList.add('text-danger');
                } else {
                    document.getElementById('currentScore').classList.remove('text-danger');
                    document.getElementById('visitorCurrentScore').classList.remove('text-danger');
                }
                
                // 更新积分显示
                document.getElementById('visitorCurrentScore').textContent = appData.score;
                
                // 更新上周差距显示
                document.getElementById('visitorLastWeekGap').textContent = appData.lastWeekGap >= 0 
                    ? `差 ${appData.lastWeekGap} 分` 
                    : `超额 ${-appData.lastWeekGap} 分`;
                
                // 更新今日任务状态
                const completedCount = appData.tasks.filter(t => t.status === 'approved').length;
                const totalCount = appData.tasks.length;
                document.getElementById('todayTaskStatus').textContent = `${completedCount}/${totalCount}`;
                
                // 渲染访客任务列表
                this.renderVisitorTasks();
                
                // 渲染分数统计图表
                this.renderScoreCharts();
                
                // 渲染访客任务历史
                this.renderVisitorTaskHistory();
            },
            
            // 渲染分数统计图表
            renderScoreCharts() {
                if (appData.currentUser === 'admin') {
                    this.updateChartData(this.adminScoreChart, appData.scoreHistory);
                } else if (appData.currentUser === 'visitor') {
                    this.updateChartData(this.visitorScoreChart, appData.scoreHistory);
                }
            },
            
            // 渲染待审核任务
            renderPendingReviews() {
                const reviewList = document.getElementById('pendingReviewList');
                const reviewCount = document.getElementById('reviewCount');
                const noReviewMessage = document.getElementById('noPendingReviewMessage');
                
                // 获取所有待审核的任务
                const pendingTasks = appData.tasks.filter(t => t.status === 'submitted');
                
                // 更新待审核计数
                reviewCount.textContent = pendingTasks.length;
                
                // 清空列表
                reviewList.innerHTML = '';
                
                // 如果没有待审核任务，显示提示信息
                if (pendingTasks.length === 0) {
                    reviewList.appendChild(noReviewMessage);
                    return;
                }
                
                // 添加待审核任务项
                pendingTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'flex items-center justify-between p-3 border border-warning/30 bg-warning/5 rounded-lg hover:bg-warning/10 transition-colors hover-lift';
                    
                    // 为延续任务添加特殊标记
                    const carriedOverBadge = task.isCarriedOver ? 
                        '<span class="ml-2 px-1.5 py-0.5 bg-primary/10 text-primary rounded text-xs">延续任务</span>' : '';
                    
                    taskElement.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="mr-3 text-warning">
                                <i class="fa fa-clock-o"></i>
                            </div>
                            <div>
                                <p class="font-medium">${task.text}${carriedOverBadge}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    提交于 ${this.formatDateTime(task.submittedAt)}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="reject-task-btn px-3 py-1 bg-danger text-white rounded text-sm hover:bg-danger/90 transition-colors" 
                                    data-task-id="${task.id}">
                                <i class="fa fa-times mr-1"></i>拒绝
                            </button>
                            <button class="approve-task-btn px-3 py-1 bg-success text-white rounded text-sm hover:bg-success/90 transition-colors" 
                                    data-task-id="${task.id}">
                                <i class="fa fa-check mr-1"></i>通过
                            </button>
                        </div>
                    `;
                    
                    reviewList.appendChild(taskElement);
                });
                
                // 绑定审核按钮事件
                document.querySelectorAll('.approve-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.getAttribute('data-task-id');
                        const success = appData.reviewTask(taskId, true);
                        if (success) {
                            this.renderPendingReviews();
                            this.renderTasks();
                            this.renderTaskHistory();
                            this.updateScoreDisplays();
                            this.renderScoreCharts();
                            appData.showNotification('任务已审核通过', 'success');
                        }
                    });
                });
                
                document.querySelectorAll('.reject-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.getAttribute('data-task-id');
                        const task = appData.tasks.find(t => t.id === taskId);
                        
                        this.showConfirmModal(
                            `确认要拒绝任务"${task.text}"吗？用户需要重新完成。`,
                            () => {
                                const success = appData.reviewTask(taskId, false);
                                if (success) {
                                    this.renderPendingReviews();
                                    this.renderTasks();
                                    appData.showNotification('任务已拒绝', 'info');
                                }
                            }
                        );
                    });
                });
            },
            
            // 渲染管理员任务列表
            renderTasks() {
                const tasksList = document.getElementById('adminTasksList');
                const taskCount = document.getElementById('taskCount');
                const noTasksMessage = document.getElementById('noTasksMessage');
                
                // 更新任务计数
                taskCount.textContent = appData.tasks.length;
                
                // 清空列表
                tasksList.innerHTML = '';
                
                // 如果没有任务，显示提示信息
                if (appData.tasks.length === 0) {
                    tasksList.appendChild(noTasksMessage);
                    return;
                }
                
                // 添加任务项
                appData.tasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors hover-lift';
                    
                    // 根据任务状态设置边框颜色
                    if (task.status === 'submitted') {
                        taskElement.classList.add('border-warning/30', 'bg-warning/5');
                    } else if (task.status === 'approved' || task.status === 'completed') {
                        taskElement.classList.add('border-success/30', 'bg-success/5');
                    } else if (task.status === 'rejected') {
                        taskElement.classList.add('border-danger/30', 'bg-danger/5');
                    }
                    
                    // 为延续任务添加特殊标记
                    const carriedOverBadge = task.isCarriedOver ? 
                        '<span class="ml-2 px-1.5 py-0.5 bg-primary/10 text-primary rounded text-xs">延续任务</span>' : '';
                    
                    // 为自动通过的任务添加标记
                    const autoApprovedBadge = task.isAutoApproved ? 
                        '<span class="ml-2 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">自动通过</span>' : '';
                    
                    // 根据任务状态设置不同样式
                    let statusBadge = '';
                    let actionButtons = '';
                    
                    if (task.status === 'pending') {
                        statusBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">待完成</span>';
                        actionButtons = `
                            <div class="flex items-center space-x-2">
                                <button class="delete-task-btn px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors" 
                                        data-task-id="${task.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else if (task.status === 'submitted') {
                        statusBadge = '<span class="px-2 py-1 bg-warning/10 text-warning rounded-full text-xs">待审核</span>';
                        actionButtons = `
                            <div class="flex items-center space-x-2">
                                <button class="delete-task-btn px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors" 
                                        data-task-id="${task.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        `;
                    } else if (task.status === 'approved') {
                        statusBadge = '<span class="px-2 py-1 bg-success/10 text-success rounded-full text-xs">已通过</span>';
                        actionButtons = `
                            <button class="delete-task-btn px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors" 
                                    data-task-id="${task.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        `;
                        taskElement.classList.add('opacity-70');
                    } else if (task.status === 'rejected') {
                        statusBadge = '<span class="px-2 py-1 bg-danger/10 text-danger rounded-full text-xs">已拒绝</span>';
                        actionButtons = `
                            <div class="flex items-center space-x-2">
                                <button class="delete-task-btn px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors" 
                                        data-task-id="${task.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                    
                    taskElement.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="mr-3 text-gray-400">
                                <i class="fa fa-list-alt"></i>
                            </div>
                            <div>
                                <p class="font-medium">${task.text}${carriedOverBadge}${autoApprovedBadge}</p>
                                <p class="text-xs text-gray-500 mt-1">${this.formatDateTime(task.createdAt)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                            ${actionButtons}
                        </div>
                    `;
                    
                    tasksList.appendChild(taskElement);
                });
                
                // 绑定任务删除按钮事件
                document.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.getAttribute('data-task-id');
                        const task = appData.tasks.find(t => t.id === taskId);
                        
                        this.showConfirmModal(
                            `确认要删除任务"${task.text}"吗？`,
                            () => {
                                const success = appData.deleteTask(taskId);
                                if (success) {
                                    this.renderTasks();
                                    this.renderPendingReviews();
                                    appData.showNotification('任务已删除', 'info');
                                }
                            }
                        );
                    });
                });
            },
            
            // 渲染访客任务列表
            renderVisitorTasks() {
                const tasksList = document.getElementById('visitorTasksList');
                const noTasksMessage = document.getElementById('noVisitorTasksMessage');
                
                // 清空列表
                tasksList.innerHTML = '';
                
                // 如果没有任务，显示提示信息
                if (appData.tasks.length === 0) {
                    tasksList.appendChild(noTasksMessage);
                    return;
                }
                
                // 添加任务项
                appData.tasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors hover-lift';
                    
                    // 根据任务状态设置边框颜色
                    if (task.status === 'submitted') {
                        taskElement.classList.add('border-warning/30', 'bg-warning/5');
                    } else if (task.status === 'approved') {
                        taskElement.classList.add('border-success/30', 'bg-success/5');
                    } else if (task.status === 'rejected') {
                        taskElement.classList.add('border-danger/30', 'bg-danger/5');
                    }
                    
                    // 为延续任务添加特殊标记
                    const carriedOverBadge = task.isCarriedOver ? 
                        '<span class="ml-2 px-1.5 py-0.5 bg-primary/10 text-primary rounded text-xs">延续任务</span>' : '';
                    
                    // 为自动通过的任务添加标记
                    const autoApprovedBadge = task.isAutoApproved ? 
                        '<span class="ml-2 px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">自动通过</span>' : '';
                    
                    // 根据任务状态设置不同样式
                    let statusBadge = '';
                    let actionButton = '';
                    
                    if (task.status === 'pending') {
                        statusBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">待完成</span>';
                        actionButton = `
                            <button class="submit-task-btn w-full py-2 mt-3 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium transition-all flex items-center justify-center">
                                <i class="fa fa-check-circle mr-2"></i>完成并提交
                            </button>
                        `;
                    } else if (task.status === 'submitted') {
                        statusBadge = '<span class="px-2 py-1 bg-warning/10 text-warning rounded-full text-xs">待审核</span>';
                        actionButton = `
                            <div class="w-full py-2 mt-3 bg-gray-100 text-gray-500 rounded-lg font-medium transition-all flex items-center justify-center">
                                <i class="fa fa-clock-o mr-2"></i>等待管理员审核
                            </div>
                        `;
                    } else if (task.status === 'approved') {
                        statusBadge = '<span class="px-2 py-1 bg-success/10 text-success rounded-full text-xs">已通过</span>';
                        actionButton = `
                            <div class="w-full py-2 mt-3 bg-success/10 text-success rounded-lg font-medium transition-all flex items-center justify-center">
                                <i class="fa fa-check-circle mr-2"></i>任务已通过审核
                            </div>
                        `;
                        taskElement.classList.add('opacity-70');
                    } else if (task.status === 'rejected') {
                        statusBadge = '<span class="px-2 py-1 bg-danger/10 text-danger rounded-full text-xs">已拒绝</span>';
                        actionButton = `
                            <button class="submit-task-btn w-full py-2 mt-3 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium transition-all flex items-center justify-center">
                                <i class="fa fa-redo mr-2"></i>重新完成并提交
                            </button>
                        `;
                    }
                    
                    taskElement.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <div class="mr-3 text-gray-400 mt-0.5">
                                        <i class="fa fa-list-alt"></i>
                                    </div>
                                    <p class="font-medium">${task.text}${carriedOverBadge}${autoApprovedBadge}</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${this.formatDateTime(task.createdAt)}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        ${actionButton}
                    `;
                    
                    tasksList.appendChild(taskElement);
                });
                
                // 绑定任务提交按钮事件
                document.querySelectorAll('.submit-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // 获取最近的任务元素
                        const taskElement = e.currentTarget.closest('div[class*="p-4 border"]');
                        // 获取任务文本以找到对应的任务ID
                        const taskTextElement = taskElement.querySelector('.font-medium');
                        const taskText = taskTextElement.textContent.replace('延续任务', '').replace('自动通过', '').trim();
                        
                        // 找到对应的任务
                        const task = appData.tasks.find(t => t.text === taskText);
                        
                        if (task) {
                            // 如果是被拒绝的任务，先重置状态为待完成
                            if (task.status === 'rejected') {
                                task.status = 'pending';
                            }
                            
                            const success = appData.submitTask(task.id);
                            if (success) {
                                this.renderVisitorTasks();
                                appData.showNotification('任务已提交，等待管理员审核', 'info');
                            }
                        }
                    });
                });
            },
            
            // 渲染管理员任务历史
            renderTaskHistory() {
                const historyContainer = document.getElementById('taskHistory');
                
                // 清空列表
                historyContainer.innerHTML = '';
                
                // 如果没有历史记录，显示提示信息
                if (appData.taskHistory.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-6">
                            暂无历史记录
                        </div>
                    `;
                    return;
                }
                
                // 按日期分组显示历史记录
                const historyByDate = {};
                appData.taskHistory.forEach(task => {
                    if (!historyByDate[task.date]) {
                        historyByDate[task.date] = [];
                    }
                    historyByDate[task.date].push(task);
                });
                
                // 按日期倒序显示
                const sortedDates = Object.keys(historyByDate).sort((a, b) => new Date(b) - new Date(a));
                
                sortedDates.forEach(date => {
                    const tasksOnDate = historyByDate[date];
                    
                    // 格式化日期显示
                    const formattedDate = new Date(date).toLocaleDateString('zh-CN', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        weekday: 'long'
                    });
                    
                    // 创建日期标题
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'text-sm font-semibold text-gray-500 mt-4 mb-2';
                    dateHeader.textContent = formattedDate;
                    historyContainer.appendChild(dateHeader);
                    
                    // 添加当天的任务
                    tasksOnDate.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = 'flex items-center justify-between p-2 border-b border-gray-100 last:border-0';
                        
                        let statusIcon = '';
                        let statusText = '';
                        
                        if (task.status === 'completed') {
                            statusIcon = '<i class="fa fa-check-circle text-success mr-1"></i>';
                            statusText = '已完成';
                            
                            // 自动通过的任务添加标记
                            if (task.isAutoApproved) {
                                statusText += ' (自动通过)';
                            }
                        } else if (task.status === 'abandoned') {
                            statusIcon = '<i class="fa fa-times-circle text-danger mr-1"></i>';
                            statusText = '已放弃';
                            
                            // 自动结算的任务添加标记
                            if (task.isAutoSettled) {
                                statusText += ' (自动结算)';
                            }
                        }
                        
                        taskElement.innerHTML = `
                            <div class="flex-1">
                                <p class="text-sm">${task.text}</p>
                            </div>
                            <div class="text-xs text-gray-500 flex items-center">
                                ${statusIcon}${statusText}
                            </div>
                        `;
                        
                        historyContainer.appendChild(taskElement);
                    });
                });
            },
            
            // 渲染访客任务历史
            renderVisitorTaskHistory() {
                const historyContainer = document.getElementById('visitorTaskHistory');
                
                // 清空列表
                historyContainer.innerHTML = '';
                
                // 如果没有历史记录，显示提示信息
                if (appData.taskHistory.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-6">
                            暂无任务记录
                        </div>
                    `;
                    return;
                }
                
                // 按日期分组显示历史记录
                const historyByDate = {};
                appData.taskHistory.forEach(task => {
                    if (!historyByDate[task.date]) {
                        historyByDate[task.date] = [];
                    }
                    historyByDate[task.date].push(task);
                });
                
                // 按日期倒序显示
                const sortedDates = Object.keys(historyByDate).sort((a, b) => new Date(b) - new Date(a));
                
                sortedDates.forEach(date => {
                    const tasksOnDate = historyByDate[date];
                    
                    // 格式化日期显示
                    const formattedDate = new Date(date).toLocaleDateString('zh-CN', { 
                        month: 'short', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                    
                    // 创建日期标题
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'text-sm font-semibold text-gray-500 mt-4 mb-2';
                    dateHeader.textContent = formattedDate;
                    historyContainer.appendChild(dateHeader);
                    
                    // 添加当天的任务
                    tasksOnDate.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = 'flex items-center justify-between p-2 border-b border-gray-100 last:border-0';
                        
                        let statusIcon = '';
                        let statusText = '';
                        
                        if (task.status === 'completed') {
                            statusIcon = '<i class="fa fa-check-circle text-success mr-1"></i>';
                            statusText = '已完成';
                            
                            // 自动通过的任务添加标记
                            if (task.isAutoApproved) {
                                statusText += ' (自动通过)';
                            }
                        } else if (task.status === 'abandoned') {
                            statusIcon = '<i class="fa fa-times-circle text-danger mr-1"></i>';
                            statusText = '已放弃';
                            
                            // 自动结算的任务添加标记
                            if (task.isAutoSettled) {
                                statusText += ' (自动结算)';
                            }
                        }
                        
                        taskElement.innerHTML = `
                            <div class="flex-1">
                                <p class="text-sm">${task.text}</p>
                            </div>
                            <div class="text-xs text-gray-500 flex items-center">
                                ${statusIcon}${statusText}
                            </div>
                        `;
                        
                        historyContainer.appendChild(taskElement);
                    });
                });
            },
            
            // 更新所有积分显示
            updateScoreDisplays() {
                document.getElementById('currentScore').textContent = appData.score;
                document.getElementById('adminCurrentScore').textContent = appData.score;
                document.getElementById('visitorCurrentScore').textContent = appData.score;
                
                // 负分时显示为红色
                if (appData.score < 0) {
                    document.getElementById('currentScore').classList.add('text-danger');
                    document.getElementById('adminCurrentScore').classList.add('text-danger');
                    document.getElementById('visitorCurrentScore').classList.add('text-danger');
                } else {
                    document.getElementById('currentScore').classList.remove('text-danger');
                    document.getElementById('adminCurrentScore').classList.remove('text-danger');
                    document.getElementById('visitorCurrentScore').classList.remove('text-danger');
                }
                
                // 更新今日任务状态
                const completedCount = appData.tasks.filter(t => t.status === 'approved').length;
                const totalCount = appData.tasks.length;
                document.getElementById('todayTaskStatus').textContent = `${completedCount}/${totalCount}`;
            },
            
            // 格式化日期时间显示
            formatDateTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                
                // 检查是否是今天
                const isToday = date.toDateString() === now.toDateString();
                
                if (isToday) {
                    return `今天 ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
                }
                
                // 检查是否是昨天
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                const isYesterday = date.toDateString() === yesterday.toDateString();
                
                if (isYesterday) {
                    return `昨天 ${date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
                }
                
                // 其他日期显示年月日和时间
                return date.toLocaleString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        };

        // 初始化应用
        viewController.init();
        appData.init();
    </script>
</body>
</html>
    